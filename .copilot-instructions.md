# Copilot Instructions for Logging Server

## Core Philosophy
**Development workflow IS production workflow** - everything must be production-ready from the start.

## Deployment Architecture
**CRITICAL**: This application runs **exclusively in Docker containers**. Never attempt to start the server with `npm start` or direct Node.js execution on the host machine.

### Container Information
- **Container Name**: `Rejavarti-Logging-Server` (production/Unraid)
- **Docker Image**: `rejavarti/logging-server:latest` (on Docker Hub)
- **Network Mode**: Bridge networking with port mappings (NO macvlan)
- **Web UI Port**: `http://192.168.222.3:10180` (host port 10180 ‚Üí container port 10180)
- **WebSocket Port**: `8081`
- **Stream Port**: `8082`
- **Data Volume**: `/mnt/user/appdata/Rejavarti-Logging-Server:/app/data` (persistent database)
- **Required Environment Variables**:
  - `PORT=10180` (application listens on 10180, not 3000)
  - `JWT_SECRET=your-secret-key-change-this`
  - `NODE_ENV=development`
  - `AUTH_PASSWORD=admin123`

### Production Deployment (Unraid)
**Network Configuration**:
- **Always use bridge networking for Docker containers**
- Port mappings: `-p 10180:10180 -p 8081:8081 -p 8082:8082`
- Access via Unraid host IP: `192.168.222.3:10180`
- **Never use macvlan networks unless explicitly requested**

**Deployment Command** (Production/Unraid):
```bash
docker run -d \
  --name Rejavarti-Logging-Server \
  --restart unless-stopped \
  -p 10180:10180 -p 8081:8081 -p 8082:8082 \
  -v /mnt/user/appdata/Rejavarti-Logging-Server:/app/data \
  -e JWT_SECRET=your-secret-key-change-this \
  -e NODE_ENV=development \
  -e AUTH_PASSWORD=admin123 \
  -e PORT=10180 \
  rejavarti/logging-server:latest
```

For production deployment on Unraid servers:
- üìñ **Quick Start Guide**: See `UNRAID_QUICKSTART.md` for 5-minute setup
- üìñ **Full Documentation**: See `UNRAID_SETUP.md` for comprehensive guide
- üöÄ **Auto-Deploy Script**: Use `unraid-deploy.sh` for automated installation
- üì¶ **Template**: Use `unraid-template.xml` for Community Applications

### IMPORTANT: Production vs Development Mode
**This is a PRODUCTION deployment** - there are NO bind mounts to local code.
- ‚ùå Code changes on local machine do NOT affect running container
- ‚ùå `pm2 reload` will NOT pick up local changes
- ‚úÖ To deploy code changes: commit ‚Üí push to git ‚Üí rebuild Docker image ‚Üí push to Docker Hub ‚Üí redeploy container
- üîÑ Changes require full rebuild cycle (see "Full Deployment Workflow" below)

### Required Commands

#### Full Deployment Workflow (Production)
**CRITICAL**: After ANY code changes, follow this complete workflow:

```powershell
# 1. Commit changes to git
git add .
git commit -m "Description of changes"
git push

# 2. SSH to Unraid and rebuild Docker image from GitHub
ssh root@192.168.222.3 "rm -rf /tmp/logging_server && git clone https://github.com/rejavarti/logging_server.git /tmp/logging_server && cd /tmp/logging_server && docker build -t rejavarti/logging-server:latest ."

# 3. Push to Docker Hub (authenticate first if needed)
# Login: echo 'YOUR_PASSWORD' | ssh root@192.168.222.3 "docker login -u tom@macd.ca --password-stdin"
ssh root@192.168.222.3 "docker push rejavarti/logging-server:latest"

# 4. Redeploy container on Unraid
ssh root@192.168.222.3 "docker stop Rejavarti-Logging-Server && docker rm Rejavarti-Logging-Server && docker run -d --name Rejavarti-Logging-Server --restart unless-stopped -p 10180:10180 -p 8081:8081 -p 8082:8082 -v /mnt/user/appdata/Rejavarti-Logging-Server:/app/data -e JWT_SECRET=your-secret-key-change-this -e NODE_ENV=development -e AUTH_PASSWORD=admin123 -e PORT=10180 rejavarti/logging-server:latest"

# 5. Verify deployment
ssh root@192.168.222.3 "docker logs Rejavarti-Logging-Server --tail 20"
```

**ALWAYS complete ALL 5 steps** - partial deployments cause version mismatches between git/Docker/container.

#### Quick Status Checks
```powershell
# Check container status
ssh root@192.168.222.3 "docker ps | grep Rejavarti"

# View logs
ssh root@192.168.222.3 "docker logs Rejavarti-Logging-Server --tail 50 -f"

# Check database
ssh root@192.168.222.3 "docker exec Rejavarti-Logging-Server sqlite3 /app/data/databases/enterprise_logs.db 'SELECT COUNT(*) FROM logs'"
```

#### Health Checks
```powershell
# Check health endpoint (from local machine)
Invoke-WebRequest -Uri "http://192.168.222.3:10180/health" -UseBasicParsing

# Verify container health
ssh root@192.168.222.3 "docker inspect Rejavarti-Logging-Server --format='{{.State.Health.Status}}'"
```

## Development Workflow Rules

1. **Always commit changes to git immediately after making them** - never leave uncommitted code
2. **Always follow the complete 5-step deployment workflow** - commit ‚Üí rebuild ‚Üí push Docker Hub ‚Üí redeploy ‚Üí verify
3. **Always verify container is running on Unraid** before troubleshooting
4. **Always use port 10180** for web access (container listens on 10180, NOT 3000)
5. **Always SSH to Unraid for container operations** - container runs on 192.168.222.3, not localhost
6. **Never skip git commits** - Docker images are built from GitHub, not local files
7. **Never use bind mounts for production** - full rebuild required for all changes
8. **Never leave partial deployments** - always complete all 5 steps of deployment workflow

## Code Standards

### Feature Implementation Policy
- **NO placeholders, stubs, or "future consideration" code**
- Every feature added must have **full, working implementation**
- All endpoints must have real logic, not 501 responses
- **If a button exists in the UI, the backend endpoint must be functional**
- **All buttons must work with proper endpoints - no exceptions**
- Test all features before considering them complete
- Development = Production quality standards

### File Structure
- Routes: `routes/`
- APIs: `routes/api/`
- Engines: `engines/`
- Configs: `configs/`
- Templates: `configs/templates/`
- Public assets: `public/`

### Database Access
- Always use `database-access-layer.js` (DAL) for all database operations
- Never use direct SQLite queries outside the DAL
- All DAL methods are promisified

### Security
- Authentication required for all admin routes
- JWT tokens for API authentication
- Environment variables for secrets (JWT_SECRET, AUTH_PASSWORD)
- **EXCEPTION**: `/log` endpoint has NO authentication (allows Home Assistant, ESP32, and other IoT devices to POST logs without credentials)
- **Home Assistant Integration**: Uses `rest_command` to POST logs via HTTP without authentication
- **ESP32 Integration**: Devices POST directly to `/log` without credentials

## Current System State

### Recent Fixes & Enhancements (Dec 2025)
- **Widget Sizes**: Reduced by 20% (240x200, 320x320, 480x320)
- **Logs Today Fix**: Uses timezone-aware query with `localtime` for accurate daily counts
- **Auto-save Layout**: ResizeObserver with 1s debounce automatically saves widget positions/sizes
- **Position Validation**: Relaxed to allow small negative positions (< -50px) for edge dragging
- **Server Location Settings**: Added city, latitude, longitude fields in settings for map display
- **Authentication Fix**: `/log` endpoint has NO authentication to allow Home Assistant and ESP32 devices to POST logs
- **Cache Busting**: ETag headers and version stamps to prevent browser caching issues
- **HTTP Compatibility**: Removed Cross-Origin security headers that forced HTTPS upgrade

### Dashboard Features
- **Main Dashboard**: `/dashboard` - Fully functional with widget grid (Muuri), charts (ECharts), and live data
- **Dashboard Builder**: REMOVED - Engine disabled, routes unmounted, sidebar links removed
- **Widget Marketplace**: Available in main dashboard with install functionality
- **Layout Persistence**: Server-side via `/api/dashboard/positions` (GET/POST) with localStorage fallback
- **Reset Layout**: `/api/dashboard/reset-positions` clears saved positions
- **Auto-save on Resize**: Widgets automatically save size changes after 1 second debounce

### Assets & Dependencies
- All vendor assets served locally from `/public/vendor/` (no CDN dependencies)
- Muuri 0.9.5 for drag/drop grid
- Apache ECharts 5.x for charts
- Font Awesome 6.x for icons
- CSP configured to allow worker-src blob for Muuri

### Data Seeding
```powershell
# Seed integrations
node scripts/seed-integrations.js

# Seed logs
node scripts/seed-logs.js

# Seed integration documentation
node scripts/seed-integration-docs.js

# Seed all
npm run seed:all
```

## Troubleshooting Priority

1. **"Can't connect to server"** ‚Üí Check container is running: `ssh root@192.168.222.3 "docker ps | grep Rejavarti"`
2. **"Changes not showing"** ‚Üí Did you complete all 5 deployment steps? Check git status and Docker image timestamp
3. **"Logs not flowing from Home Assistant"** ‚Üí Check `/log` endpoint has NO authentication middleware
4. **"Container won't start"** ‚Üí Check logs: `ssh root@192.168.222.3 "docker logs Rejavarti-Logging-Server"`
5. **"Database errors"** ‚Üí Verify volume mount: `ssh root@192.168.222.3 "docker exec Rejavarti-Logging-Server ls -la /app/data/databases"`
6. **"Browser showing old code"** ‚Üí Hard refresh (Ctrl+Shift+R) or check ETag version stamp
7. **"Port not accessible"** ‚Üí Verify port mapping: `ssh root@192.168.222.3 "docker port Rejavarti-Logging-Server"`
8. **"Git/Docker/Container out of sync"** ‚Üí Run full 5-step deployment workflow from scratch

## What NOT to Do

‚ùå Never run `npm start` on the host  
‚ùå Never create scripts that run Node directly outside Docker  
‚ùå Never assume port 3000 is accessible (container uses 10180)  
‚ùå Never assume localhost works (container runs on Unraid 192.168.222.3)
‚ùå Never skip git commits before rebuilding Docker image
‚ùå Never do partial deployments (must complete all 5 steps)
‚ùå Never use hot-patches without following up with full deployment
‚ùå Never add authentication to `/log` endpoint (breaks Home Assistant/ESP32)
‚ùå Never modify code without reloading the container  
‚ùå Never suggest recreating features that were explicitly removed (Dashboard Builder)  
‚ùå Never use CDN links (all assets are vendored locally)  
‚ùå Never use macvlan networking (bridge only)
‚ùå Never create placeholder/stub implementations - all features must be fully functional
‚ùå Never add buttons without working backend endpoints
‚ùå Never leave uncommitted changes in the repository
‚ùå Never rebuild Docker image from stale git commits

## User Expectations
- "I want ALL buttons working with proper endpoints" - no exceptions
- Every feature must be production-ready when shipped
- No incomplete implementations
- UI controls must have working backend handlers
- **ALL changes must be committed to git immediately**
- **ALL changes must go through complete 5-step deployment workflow**
- "What we had before" means committed code in git, not hot-patches
- Never blame user configuration when the issue is in the code
- Always verify git/Docker/container are synchronized before troubleshooting

## Emergency Recovery

If the container is broken:
```powershell
# Full rebuild from GitHub (latest commit)
ssh root@192.168.222.3 "rm -rf /tmp/logging_server && git clone https://github.com/rejavarti/logging_server.git /tmp/logging_server && cd /tmp/logging_server && docker build -t rejavarti/logging-server:latest . && docker push rejavarti/logging-server:latest && docker stop Rejavarti-Logging-Server && docker rm Rejavarti-Logging-Server && docker run -d --name Rejavarti-Logging-Server --restart unless-stopped -p 10180:10180 -p 8081:8081 -p 8082:8082 -v /mnt/user/appdata/Rejavarti-Logging-Server:/app/data -e JWT_SECRET=your-secret-key-change-this -e NODE_ENV=development -e AUTH_PASSWORD=admin123 -e PORT=10180 rejavarti/logging-server:latest"

# Check recovery
ssh root@192.168.222.3 "docker logs Rejavarti-Logging-Server --tail 30"
```

## Resilience & Reliability (Phase 1 Enhancements)
The system now includes automatic resilience mechanisms to prevent data loss and improve observability.

### New Core Tables
- `transaction_log`: Forensic record of all multi-step operations (status: pending ‚Üí committed / rolled_back / failed).
- `failed_operations_queue`: Captures transient failures (e.g., inserts) with automatic retry and exponential backoff.
- `system_error_log`: Centralized error store with deduplication fields (occurrence_count, first_seen, last_seen).
- `database_health_log`: Daily snapshots of database integrity & size.

### Worker Scheduling
- Failed operation retry worker runs every 60s (replays `log_insert` operations; extensible for other types).
- Health snapshot worker runs every 24h (quick_check + size + table counts).

### DAL Helper Methods
- `dal.logTransaction(entry)` and `dal.updateTransactionStatus(id, status, error)`.
- `dal.queueFailedOperation(op)` / `dal.fetchRetryableFailedOperations(limit)` / `dal.markFailedOperation(id, fields)`.
- `dal.logSystemError(entry)` for structured error auditing.
- `dal.logDatabaseHealthSnapshot(snapshot)` for daily metrics.

### Retry Backoff Logic
Retry intervals use exponential backoff: `2^attempt * 60s` until `max_retries` reached (then status ‚Üí `abandoned`).

### When to Use Failed Operation Queue
Use only for transient, recoverable failures (DB busy, lock timeouts, write conflicts). Do NOT queue logical validation errors.

### Testing & Verification (Added to unified test)
1. Verify presence of 4 resilience tables.
2. Force a controlled insert error; ensure a row appears in `failed_operations_queue` and later succeeds.
3. Log a synthetic system error and confirm row in `system_error_log`.
4. Verify a health snapshot row in `database_health_log` (may mock immediate call in test).

### Operational Guidelines
- Never manually delete rows from `failed_operations_queue`; mark abandoned for audit.
- Investigate `system_error_log` spikes by grouping on `error_code` and `affected_component`.
- Use `transaction_log` to reconstruct multi-step flows during incident analysis.
- Automate backup verification and append results to `database_health_log` (future phase).

### Future Extension Points
- Add support for streaming retry metrics to dashboard.
- Circuit breaker table to complement `integration_health` for external services.
- Query performance logging table for slow query detection.

