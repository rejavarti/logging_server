# Copilot Instructions for Logging Server

## Deployment Architecture
**CRITICAL**: This application runs **exclusively in Docker containers**. Never attempt to start the server with `npm start` or direct Node.js execution on the host machine.

### Container Information
- **Container Name**: `rejavarti-logging-server` (dev) / `enterprise-logging-server` (production/Unraid)
- **Web UI Port**: `http://localhost:10180` (container port 10180 ‚Üí host port 10180)
- **WebSocket Port**: `localhost:8081`
- **Stream Port**: `localhost:8082`

### Production Deployment (Unraid)
For production deployment on Unraid servers:
- üìñ **Quick Start Guide**: See `UNRAID_QUICKSTART.md` for 5-minute setup
- üìñ **Full Documentation**: See `UNRAID_SETUP.md` for comprehensive guide
- üöÄ **Auto-Deploy Script**: Use `unraid-deploy.sh` for automated installation
- üì¶ **Template**: Use `unraid-template.xml` for Community Applications

### Development Mode - Bind Mounts
The Docker container has **bind mounts** to the local workspace, meaning:
- ‚úÖ Code changes on your local machine are **immediately reflected** in the container
- ‚úÖ No rebuild required for code changes
- ‚ö†Ô∏è After editing files, you must reload the app with `pm2 reload all` inside the container
- üìÅ Mounted directories: `routes/`, `public/`, `views/`, `utils/`, `configs/`, and `data/`

### Required Commands

#### Start/Stop Container
```powershell
# Start Docker Desktop first (if not running)
Start-Process "C:\Program Files\Docker\Docker\Docker Desktop.exe"

# Check container status
docker ps -a --filter "name=rejavarti-logging-server"

# Start container (from docker-files directory)
cd "C:\Users\Tom Nelson\Documents\Visual_Studio_Code\Node-Red-Home-Assistant\logging-server\docker-files"
docker-compose up -d

# Stop container
docker-compose down

# Restart container
docker-compose restart
```

#### After Code Changes
```powershell
# Reload application inside container (no rebuild needed in dev mode)
docker exec rejavarti-logging-server pm2 reload all

# View logs
docker logs rejavarti-logging-server --tail 50 -f
docker exec rejavarti-logging-server pm2 logs logging-server
```

#### Health Checks
```powershell
# Check health endpoint
Invoke-WebRequest -Uri "http://localhost:10180/health" -UseBasicParsing

# Verify port mappings
docker port rejavarti-logging-server
```

## Development Workflow Rules

1. **Always verify Docker is running** before attempting any server operations
2. **Always use container port 10180** for web access, not port 3000
3. **Always reload with `docker exec ... pm2 reload all`** after code changes (bind mounts are active in dev)
4. **Never create npm scripts** that run `node server.js` directly on the host
5. **Always check container logs** for errors, not host terminal output

## Code Standards

### File Structure
- Routes: `routes/`
- APIs: `routes/api/`
- Engines: `engines/`
- Configs: `configs/`
- Templates: `configs/templates/`
- Public assets: `public/`

### Database Access
- Always use `database-access-layer.js` (DAL) for all database operations
- Never use direct SQLite queries outside the DAL
- All DAL methods are promisified

### Security
- Authentication required for all admin routes
- JWT tokens for API authentication
- Environment variables for secrets (JWT_SECRET, AUTH_PASSWORD)

## Current System State

### Dashboard Features
- **Main Dashboard**: `/dashboard` - Fully functional with widget grid (Muuri), charts (ECharts), and live data
- **Dashboard Builder**: REMOVED - Engine disabled, routes unmounted, sidebar links removed
- **Widget Marketplace**: Available in main dashboard with install functionality
- **Layout Persistence**: Server-side via `/api/dashboard/positions` (GET/POST) with localStorage fallback
- **Reset Layout**: `/api/dashboard/reset-positions` clears saved positions

### Assets & Dependencies
- All vendor assets served locally from `/public/vendor/` (no CDN dependencies)
- Muuri 0.9.5 for drag/drop grid
- Apache ECharts 5.x for charts
- Font Awesome 6.x for icons
- CSP configured to allow worker-src blob for Muuri

### Data Seeding
```powershell
# Seed integrations
node scripts/seed-integrations.js

# Seed logs
node scripts/seed-logs.js

# Seed integration documentation
node scripts/seed-integration-docs.js

# Seed all
npm run seed:all
```

## Troubleshooting Priority

1. **"Can't connect"** ‚Üí Check Docker is running: `docker ps`
2. **"Port conflict"** ‚Üí Container uses host port 10180, not 3000
3. **"Changes not reflected"** ‚Üí Reload: `docker exec rejavarti-logging-server pm2 reload all`
4. **"Container won't start"** ‚Üí Check logs: `docker logs rejavarti-logging-server`
5. **"Database errors"** ‚Üí Verify bind mounts: `docker exec rejavarti-logging-server ls -la /app/data`

## What NOT to Do

‚ùå Never run `npm start` on the host  
‚ùå Never create scripts that run Node directly outside Docker  
‚ùå Never assume port 3000 is accessible on localhost (use 10180)  
‚ùå Never modify code without reloading the container  
‚ùå Never suggest recreating features that were explicitly removed (Dashboard Builder)  
‚ùå Never use CDN links (all assets are vendored locally)  

## Emergency Recovery

If the container is broken:
```powershell
cd "C:\Users\Tom Nelson\Documents\Visual_Studio_Code\Node-Red-Home-Assistant\logging-server\docker-files"
docker-compose down
docker-compose build --no-cache
docker-compose up -d
docker logs rejavarti-logging-server -f
```
